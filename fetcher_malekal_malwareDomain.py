import requests
import re
from pymemcache.client import Client
from xml.dom.minidom import parseString
import sys

# User defined variables
feedaddr = 'http://malwaredb.malekal.com/export.php?type=url'
feedID = 'malekal_malware'
mkey = 'fetcher_malekal_malware:feeddata'
killchain = 'Malware'

# No user modifications needed below.
client = Client(('localhost', 11211))
result = client.get(mkey)

if isinstance(result, str):
	dom = parseString(result)
else:
	r = requests.get(feedaddr)
	client.set(mkey, r.content, expire=7200)
	dom = parseString(r.content)

xmlroot = dom.getElementsByTagName("uris")[0]
print('url,feedID,killchain,description,method')

for entry in xmlroot.getElementsByTagName("url"):
	url = entry.getElementsByTagName('address')[0].firstChild
	if url is None: continue
	url = url.nodeValue.strip()
	msplit = url.split('://')
	methodtype = msplit[0]
	url = msplit[1]
	sys.stdout.write(url)
	sys.stdout.write(',')
	sys.stdout.write(feedID)
	sys.stdout.write(',')
	sys.stdout.write(killchain)
	sys.stdout.write(',')
	sys.stdout.write('Malekal malware URL list')
	sys.stdout.write(',')
	sys.stdout.write(methodtype)
	print


