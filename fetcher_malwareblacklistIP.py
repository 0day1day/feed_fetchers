import requests
import re
from pymemcache.client import Client
from xml.dom.minidom import parseString
import sys

# User defined variables
feedaddr = 'http://www.malwareblacklist.com/mbl.xml'
feedID = 'malwareblacklist'
mkey = 'fetcher_malwareblacklist:feeddata'
killchain = 'Exploit'

# No user modifications needed below.
client = Client(('localhost', 11211))
result = client.get(mkey)

if isinstance(result, str):
	dom = parseString(result)
else:
	r = requests.get(feedaddr)
	client.set(mkey, r.content, expire=7200)
	dom = parseString(r.content)

xmlroot = dom.getElementsByTagName("channel")[0]
print('ipv4,feedID,killchain,description,link,url')

for entry in xmlroot.getElementsByTagName("item"):
	ip = entry.getElementsByTagName('description')[0].firstChild.nodeValue
	ip = re.sub('.*IP address\: ', '', ip)
	ip = re.sub(' .*$', '', ip)
	sys.stdout.write(ip)
	sys.stdout.write(',')
	sys.stdout.write(feedID)
	sys.stdout.write(',')
	sys.stdout.write(killchain)
	sys.stdout.write(',')
	sys.stdout.write('Malwareblacklist malware list')
	sys.stdout.write(',')
	sys.stdout.write(entry.getElementsByTagName('link')[0].firstChild.nodeValue)
	sys.stdout.write(',')
	orig_url = entry.getElementsByTagName('title')[0].firstChild.nodeValue
	orig_url = re.sub(' .*$', '', orig_url)
	sys.stdout.write(orig_url)
	print


